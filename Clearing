SELECT  
  SDM_FECHA_CIERRE,
  SUM(CASE WHEN SDM_SALDO_FINAL = 0 THEN 0 ELSE 1 END) AS NUM_TARJETAS,
  VLD_TX_INTERNA,
  -- DÍAS DE MORA (calculado con fecha vencimiento original)
  (CASE 
     WHEN SDM_FECHA_MORA IS NULL THEN 0
     WHEN SDM_FECHA_CIERRE - SDM_FECHA_VENCIMIENTO <= 0 THEN 0
     ELSE SDM_FECHA_CIERRE - SDM_FECHA_VENCIMIENTO
   END) AS SDM_DIAS_MORA,
  -- RANGO DE MORA (NÚMERO DE MESES, MÁXIMO 9) calculado con fecha vencimiento original
  (CASE 
     WHEN SDM_FECHA_MORA IS NULL THEN 0
     WHEN (SDM_FECHA_CIERRE - SDM_FECHA_VENCIMIENTO) / 30 <= 0 THEN 0
     ELSE LEAST(ROUND((SDM_FECHA_CIERRE - SDM_FECHA_VENCIMIENTO) / 30), 9)
   END) AS RANGO_MORA,
  SUM(SDM_SALDO_INICIAL), 
  SUM(SDM_ALTAS), 
  SUM(SDM_PAGOS), 
  SUM(SDM_ABONOS), 
  SUM(SDM_AJUSTES), 
  SUM(SDM_EGRESOS), 
  SUM(SDM_NC), 
  SUM(SDM_SALDO_FINAL), 
  SUM(SDM_SALDO_INICIAL_FINANCIADO), 
  SUM(SDM_ALTAS_FINANCIADO), 
  SUM(SDM_PAGOS_FINANCIADO), 
  SUM(SDM_ABONOS_FINANCIADO), 
  SUM(SDM_AJUSTES_FINANCIADO), 
  SUM(SDM_EGRESOS_FINANCIADO), 
  SUM(SDM_NC_FINANCIADO), 
  SUM(SDM_SALDO_FINAL_FINANCIADO),
  SUM(NVL(SDM_ENAGENACION, 0)),
  SUM(NVL(SDM_ENAGENACION_FINANCIADO, 0)),
  -- MORA OPERACIÓN (Días traducidos a tramos) también con fecha vencimiento original
  CASE 
    WHEN SDM_FECHA_CIERRE - NVL(FECHA_VCTO_OPERACION, SDM_FECHA_VENCIMIENTO) <= 0 THEN 0 
    WHEN SDM_FECHA_CIERRE - NVL(FECHA_VCTO_OPERACION, SDM_FECHA_VENCIMIENTO) < 31 THEN 1 
    WHEN SDM_FECHA_CIERRE - NVL(FECHA_VCTO_OPERACION, SDM_FECHA_VENCIMIENTO) < 61 THEN 2 
    WHEN SDM_FECHA_CIERRE - NVL(FECHA_VCTO_OPERACION, SDM_FECHA_VENCIMIENTO) < 91 THEN 3
    WHEN SDM_FECHA_CIERRE - NVL(FECHA_VCTO_OPERACION, SDM_FECHA_VENCIMIENTO) < 121 THEN 4
    WHEN SDM_FECHA_CIERRE - NVL(FECHA_VCTO_OPERACION, SDM_FECHA_VENCIMIENTO) < 151 THEN 5
    WHEN SDM_FECHA_CIERRE - NVL(FECHA_VCTO_OPERACION, SDM_FECHA_VENCIMIENTO) < 181 THEN 6
    WHEN SDM_FECHA_CIERRE - NVL(FECHA_VCTO_OPERACION, SDM_FECHA_VENCIMIENTO) < 361 THEN 7 
    ELSE 8 
  END AS MORA_OPERACION,
vld_tx_origen
FROM 
  RV_CLIENTES A
  JOIN RV_SALDO_DOCUMENTAL_MENSUAL B ON A.CLI_CODIGO = B.CLI_CODIGO
WHERE
  SDM_VERSION = 0
  --AND SDM_FECHA_CIERRE = ?
  AND CLI_FECHA_COMPRA <= SDM_FECHA_CIERRE
  AND B.SDM_PAT_RUT = 2
  AND VLD_TX_INTERNA <> 4418-- and vld_tx_origen not in (255648, 255649)
GROUP BY 
  SDM_FECHA_CIERRE,
  (CASE 
     WHEN SDM_FECHA_MORA IS NULL THEN 0
     WHEN SDM_FECHA_CIERRE - SDM_FECHA_VENCIMIENTO <= 0 THEN 0
     ELSE SDM_FECHA_CIERRE - SDM_FECHA_VENCIMIENTO
   END),
  (CASE 
     WHEN SDM_FECHA_MORA IS NULL THEN 0
     WHEN (SDM_FECHA_CIERRE - SDM_FECHA_VENCIMIENTO) / 30 <= 0 THEN 0
     ELSE LEAST(ROUND((SDM_FECHA_CIERRE - SDM_FECHA_VENCIMIENTO) / 30), 9)
   END),
  CASE 
    WHEN SDM_FECHA_CIERRE - NVL(FECHA_VCTO_OPERACION, SDM_FECHA_VENCIMIENTO) <= 0 THEN 0 
    WHEN SDM_FECHA_CIERRE - NVL(FECHA_VCTO_OPERACION, SDM_FECHA_VENCIMIENTO) < 31 THEN 1 
    WHEN SDM_FECHA_CIERRE - NVL(FECHA_VCTO_OPERACION, SDM_FECHA_VENCIMIENTO) < 61 THEN 2 
    WHEN SDM_FECHA_CIERRE - NVL(FECHA_VCTO_OPERACION, SDM_FECHA_VENCIMIENTO) < 91 THEN 3
    WHEN SDM_FECHA_CIERRE - NVL(FECHA_VCTO_OPERACION, SDM_FECHA_VENCIMIENTO) < 121 THEN 4
    WHEN SDM_FECHA_CIERRE - NVL(FECHA_VCTO_OPERACION, SDM_FECHA_VENCIMIENTO) < 151 THEN 5
    WHEN SDM_FECHA_CIERRE - NVL(FECHA_VCTO_OPERACION, SDM_FECHA_VENCIMIENTO) < 181 THEN 6
    WHEN SDM_FECHA_CIERRE - NVL(FECHA_VCTO_OPERACION, SDM_FECHA_VENCIMIENTO) < 361 THEN 7 
    ELSE 8 
  END,
  VLD_TX_INTERNA, vld_tx_origen
